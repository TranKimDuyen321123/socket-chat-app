<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Zalo Desktop Client</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>

    <style>
        :root {
            --sidebar-bg: #f5f6f7;
            --main-bg: #ffffff;
            --accent-color: #005ae0;
            --accent-hover: #0048b3;
            --text-color: #333;
            --border-color: #dce0e6;
            --bubble-mine: #e3f2fd;
            --bubble-theirs: #ffffff;
            --online: #2ecc71;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; user-select: none; outline: none; }
        
        /* Scrollbar đẹp cho Desktop */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #bcc0c4; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0a4a8; }

        body { height: 100vh; overflow: hidden; display: flex; background: var(--main-bg); color: var(--text-color); }

        /* === AUTH SCREEN === */
        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #e0eafc, #cfdef3); 
            z-index: 9999; display: flex; justify-content: center; align-items: center;
        }
        .auth-card {
            background: white; width: 350px; padding: 40px; border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center;
        }
        .auth-title { font-size: 24px; font-weight: bold; color: var(--accent-color); margin-bottom: 20px; }
        .input-group { margin-bottom: 15px; position: relative; text-align: left; }
        .input-group i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #888; }
        .input-group input {
            width: 100%; padding: 10px 10px 10px 35px; border: 1px solid #ccc; border-radius: 4px;
            transition: border 0.2s; font-size: 14px;
        }
        .input-group input:focus { border-color: var(--accent-color); }
        
        .btn-primary {
            width: 100%; padding: 10px; background: var(--accent-color); color: white; border: none; border-radius: 4px;
            font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 10px;
        }
        .btn-primary:hover { background: var(--accent-hover); }
        
        .switch-link { margin-top: 15px; font-size: 13px; color: #666; }
        .switch-link a { color: var(--accent-color); cursor: pointer; text-decoration: none; font-weight: 600; }
        .hidden { display: none !important; }

        /* === MAIN LAYOUT === */
        #app-layout { display: none; width: 100%; height: 100%; }

        /* SIDEBAR */
        #sidebar {
            width: 260px; background: var(--sidebar-bg); border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column;
        }
        
        .profile-header {
            height: 60px; padding: 0 15px; display: flex; align-items: center; border-bottom: 1px solid var(--border-color); background: #fff;
        }
        .my-avatar {
            width: 32px; height: 32px; background: var(--accent-color); color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 10px;
        }
        .my-name { font-weight: 600; font-size: 14px; }

        .search-bar { padding: 10px; border-bottom: 1px solid var(--border-color); display: flex; gap: 5px; }
        .search-bar input { flex: 1; padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; }
        .btn-icon { width: 30px; height: 30px; border: 1px solid #ccc; border-radius: 4px; background: white; cursor: pointer; display: flex; justify-content: center; align-items: center; color: #666; }
        .btn-icon:hover { color: var(--accent-color); border-color: var(--accent-color); }

        .list-container { flex: 1; overflow-y: auto; }
        .section-label { padding: 10px 15px 5px; font-size: 11px; font-weight: bold; color: #888; text-transform: uppercase; }

        .list-item {
            padding: 8px 15px; display: flex; align-items: center; cursor: pointer; border-left: 3px solid transparent;
        }
        .list-item:hover { background: #e8eaed; }
        .list-item.active { background: #e5f3ff; border-left-color: var(--accent-color); }

        .item-avatar {
            width: 36px; height: 36px; border-radius: 50%; background: #ccc; margin-right: 10px; position: relative;
            display: flex; justify-content: center; align-items: center; color: white; font-size: 14px;
        }
        .online-dot {
            width: 10px; height: 10px; background: var(--online); border: 2px solid var(--sidebar-bg); 
            border-radius: 50%; position: absolute; bottom: 0; right: 0;
        }
        .online-dot.offline { background: #aaa; }
        .item-info { flex: 1; overflow: hidden; }
        .item-name { font-size: 14px; font-weight: 500; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-status { font-size: 11px; color: #888; }

        /* Requests */
        .req-item {
            padding: 8px 15px; background: #fffbe6; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;
        }
        .req-btn { padding: 3px 8px; font-size: 11px; background: var(--accent-color); color: white; border: none; border-radius: 3px; cursor: pointer; }

        /* CHAT AREA */
        #chat-area { flex: 1; display: flex; flex-direction: column; background: #fff; }
        
        .chat-header {
            height: 60px; border-bottom: 1px solid var(--border-color); padding: 0 20px;
            display: flex; align-items: center; justify-content: space-between; background: #fff;
        }
        .chat-target { font-size: 16px; font-weight: 700; color: #333; }
        
        #msg-list { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; background: #f2f4f7; }
        
        .msg-row { display: flex; align-items: flex-end; }
        .msg-row.mine { justify-content: flex-end; }
        
        .bubble {
            max-width: 65%; padding: 8px 12px; border-radius: 8px; font-size: 14px; line-height: 1.4;
            position: relative; word-wrap: break-word; user-select: text; box-shadow: 0 1px 1px rgba(0,0,0,0.05);
        }
        .msg-row:not(.mine) .bubble { background: white; border: 1px solid #e5e5e5; color: #333; }
        .msg-row.mine .bubble { background: var(--bubble-mine); border: 1px solid #cce0ff; color: #333; }
        
        .msg-avatar { width: 28px; height: 28px; border-radius: 50%; background: #999; color: white; display: flex; align-items: center; justify-content: center; font-size: 10px; margin-right: 8px; }
        .msg-img { max-width: 250px; border-radius: 5px; cursor: pointer; border: 1px solid #ccc; }
        .msg-file { text-decoration: none; color: var(--accent-color); font-weight: 600; display: flex; align-items: center; gap: 5px; }

        .chat-input-box {
            padding: 15px; border-top: 1px solid var(--border-color); background: white; display: flex; gap: 10px; align-items: center;
        }
        .tool-icon { font-size: 18px; color: #666; cursor: pointer; padding: 5px; }
        .tool-icon:hover { color: var(--accent-color); }
        
        #msgInput { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        #msgInput:focus { border-color: var(--accent-color); }
    </style>
</head>
<body>

    <!-- AUTH SCREEN -->
    <div id="auth-screen">
        <div class="auth-card">
            <h2 class="auth-title" id="authTitle">Zalo Desktop</h2>
            
            <!-- Login Form -->
            <div id="login-form">
                <div class="input-group">
                    <i class="fas fa-user"></i>
                    <input type="text" id="loginUser" placeholder="Tên tài khoản" />
                </div>
                <div class="input-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="loginPass" placeholder="Mật khẩu" />
                </div>
                <button class="btn-primary" onclick="handleLogin()">ĐĂNG NHẬP</button>
                <div class="switch-link">Chưa có tài khoản? <a onclick="toggleAuth('reg')">Đăng ký</a></div>
            </div>

            <!-- Register Form -->
            <div id="reg-form" class="hidden">
                <div class="input-group">
                    <i class="fas fa-user"></i>
                    <input type="text" id="regUser" placeholder="Tên tài khoản" />
                </div>
                <div class="input-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="regPass" placeholder="Mật khẩu" />
                </div>
                <button class="btn-primary" onclick="handleReg()">ĐĂNG KÝ</button>
                <div class="switch-link">Đã có tài khoản? <a onclick="toggleAuth('login')">Đăng nhập</a></div>
            </div>
        </div>
    </div>

    <!-- APP LAYOUT -->
    <div id="app-layout">
        <div id="sidebar">
            <div class="profile-header">
                <div class="my-avatar" id="dispAvatar">U</div>
                <div class="my-name" id="dispName">User</div>
            </div>
            <div class="search-bar">
                <input type="text" id="friendSearch" placeholder="Tìm bạn (User ID)..." />
                <button class="btn-icon" onclick="addFriend()"><i class="fas fa-user-plus"></i></button>
            </div>
            <div class="list-container">
                <div id="req-list"></div>
                <div class="section-label">Tin nhắn</div>
                <div id="friend-list"></div>
            </div>
        </div>
        
        <div id="chat-area">
            <div class="chat-header">
                <div class="chat-target" id="chatHeaderName">Public Chat</div>
                <div><i class="fas fa-phone-alt tool-icon"></i> <i class="fas fa-video tool-icon"></i></div>
            </div>
            <div id="msg-list"></div>
            <div class="chat-input-box">
                <input type="file" id="fileInput" style="display:none" onchange="sendFile()" />
                <i class="fas fa-paperclip tool-icon" onclick="document.getElementById('fileInput').click()"></i>
                <i class="far fa-image tool-icon"></i>
                <input type="text" id="msgInput" placeholder="Nhập tin nhắn..." onkeypress="if(event.key==='Enter') sendMsg()" />
                <i class="fas fa-paper-plane tool-icon" style="color: var(--accent-color);" onclick="sendMsg()"></i>
            </div>
        </div>
    </div>

    <script>
        const connection = new signalR.HubConnectionBuilder().withUrl("/chatHub").withAutomaticReconnect().build();
        let currentUser = "";
        let currentTarget = "ALL";

        function toggleAuth(mode) {
            document.getElementById('login-form').classList.toggle('hidden', mode === 'reg');
            document.getElementById('reg-form').classList.toggle('hidden', mode !== 'reg');
            document.getElementById('authTitle').innerText = mode === 'reg' ? 'Đăng Ký' : 'Đăng Nhập';
        }

        async function handleLogin() {
            const u = document.getElementById('loginUser').value.trim();
            if(!u) return alert('Vui lòng nhập tên!');
            startApp(u);
        }
        async function handleReg() {
            const u = document.getElementById('regUser').value.trim();
            if(!u) return alert('Vui lòng nhập tên!');
            alert('Đăng ký thành công! Đang đăng nhập...');
            startApp(u);
        }

        async function startApp(username) {
            currentUser = username;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-layout').style.display = 'flex';
            document.getElementById('dispName').innerText = currentUser;
            document.getElementById('dispAvatar').innerText = currentUser[0].toUpperCase();

            try {
                await connection.start();
                await connection.invoke("RegisterConnection", currentUser);
            } catch(err) { alert("Lỗi kết nối!"); }
        }

        // --- EVENTS ---
        connection.on("ReceiveMessage", (msg) => { if(currentTarget === "ALL") renderMsg(msg); });
        connection.on("ReceivePrivateMessage", (msg) => { 
            if(msg.senderName === currentTarget || msg.senderName === currentUser) renderMsg(msg); 
        });
        connection.on("UpdateFriendList", renderFriends);
        connection.on("UpdateFriendRequests", renderRequests);
        connection.on("LoadHistory", (msgs) => {
            document.getElementById('msg-list').innerHTML = '';
            msgs.forEach(renderMsg);
            scrollToBottom();
        });

        // --- RENDER ---
        function stringToColor(str) {
            let hash = 0; for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            let c = '#'; for (let i = 0; i < 3; i++) c += ('00' + ((hash >> (i * 8)) & 0xFF).toString(16)).substr(-2);
            return c;
        }

        function renderFriends(list) {
            const el = document.getElementById('friend-list');
            el.innerHTML = '';
            
            // Public
            const active = currentTarget === 'ALL' ? 'active' : '';
            el.innerHTML += `<div class="list-item ${active}" onclick="switchChat('ALL')"><div class="item-avatar" style="background:#005ae0"><i class="fas fa-users"></i></div><div class="item-info"><div class="item-name">Public Chat</div><div class="item-status">Nhóm chung</div></div></div>`;

            list.forEach(f => {
                const act = currentTarget === f.username ? 'active' : '';
                const bg = stringToColor(f.username);
                const stCls = f.isOnline ? '' : 'offline';
                el.innerHTML += `<div class="list-item ${act}" onclick="switchChat('${f.username}')"><div class="item-avatar" style="background:${bg}">${f.username[0]}<div class="online-dot ${stCls}"></div></div><div class="item-info"><div class="item-name">${f.username}</div><div class="item-status">${f.isOnline ? 'Online' : 'Offline'}</div></div></div>`;
            });
        }

        function renderRequests(reqs) {
            const el = document.getElementById('req-list');
            el.innerHTML = reqs.length ? `<div class="section-label">Lời mời</div>` : '';
            reqs.forEach(r => {
                el.innerHTML += `<div class="req-item"><span>${r}</span><button class="req-btn" onclick="connection.invoke('AcceptFriendRequest', currentUser, '${r}')">Đồng ý</button></div>`;
            });
        }

        function renderMsg(msg) {
            const isMine = msg.senderName === currentUser;
            let content = msg.content;
            if(msg.type === 1) content = `<img src="${msg.content}" class="msg-img" onclick="window.open(this.src)" />`;
            else if(msg.type === 2) content = `<a href="${msg.content}" target="_blank" class="msg-file"><i class="fas fa-file-download"></i> ${msg.attachmentName}</a>`;
            
            const avatar = !isMine ? `<div class="msg-avatar" style="background:${stringToColor(msg.senderName)}">${msg.senderName[0]}</div>` : '';
            
            const html = `<div class="msg-row ${isMine ? 'mine' : ''}">${avatar}<div class="bubble">${!isMine ? `<div style="font-size:10px;color:#888;margin-bottom:2px">${msg.senderName}</div>` : ''}${content}</div></div>`;
            document.getElementById('msg-list').insertAdjacentHTML('beforeend', html);
            scrollToBottom();
        }

        function switchChat(target) {
            currentTarget = target;
            document.getElementById('chatHeaderName').innerText = target === 'ALL' ? 'Public Chat' : target;
            document.getElementById('msg-list').innerHTML = '';
            connection.invoke("LoadMessageHistory", currentUser, target);
            // Re-render active class logic omitted for brevity, ideally re-render list here
            document.querySelectorAll('.list-item').forEach(e => e.classList.remove('active')); // Simple visual fix
        }

        function sendMsg() {
            const inp = document.getElementById('msgInput');
            const txt = inp.value.trim();
            if(txt) {
                connection.invoke("SendMessage", currentUser, currentTarget, txt, 0, "");
                inp.value = '';
            }
        }
        function sendFile() {
            const f = document.getElementById('fileInput').files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = (e) => {
                if(e.target.result.length > 50000) return alert('File > 50KB demo limit');
                const type = f.type.startsWith('image') ? 1 : 2;
                connection.invoke("SendMessage", currentUser, currentTarget, e.target.result, type, f.name);
            };
            r.readAsDataURL(f);
            document.getElementById('fileInput').value = '';
        }
        function addFriend() {
            const t = document.getElementById('friendSearch').value.trim();
            if(t && t!==currentUser) {
                connection.invoke("SendFriendRequest", currentUser, t);
                document.getElementById('friendSearch').value = '';
                alert('Đã gửi lời mời!');
            }
        }
        function scrollToBottom() {
            const d = document.getElementById('msg-list');
            d.scrollTop = d.scrollHeight;
        }
    </script>
</body>
</html>
